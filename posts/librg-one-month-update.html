<!DOCTYPE html><html lang="en"><head><script>
          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
          })(window,document,'script','dataLayer','GTM-TVFMV4P');
        </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/manifest.json"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png"/><meta name="theme-color" content="#0000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="zpl.blog"/><meta property="og:image" content="https://og-image.now.sh/**zpl**%20blog.png?theme=dark&amp;md=1&amp;fontSize=125px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-bw-logo.svg&amp;widths=auto"/><title>librg - one month update! | ZPL Blog</title><meta name="author" content="Vladyslav Hrytsenko"/><meta property="og:image" content="https://og-image.now.sh/**zpl**%20blog.png?theme=dark&amp;md=1&amp;fontSize=125px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-bw-logo.svg&amp;widths=auto"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2017-10-11T00:00:00.000Z"/><meta name="next-head-count" content="29"/><link rel="preload" href="/_next/static/css/5a759f8e0f487fff0c56.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5a759f8e0f487fff0c56.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a44c54513fc11368c904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a44c54513fc11368c904.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-28e8df78bab9fb79adb9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9d524150d48315f49e80.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.4595204cc52e81c182fd.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-83685d3b0871724b112c.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.2d988ae86865e9e9ee4d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-288ab15c4ca0236ea538.js" as="script"/></head><body><div id="__next"><div class="min-h-screen"><main><div class="container mx-auto px-5 max-w-screen-lg"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/">zpl</a>.</h2><article class="mb-32"><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">librg - one month update!</h1><div class="hidden md:block md:mb-12"><div class="flex items-center"><img src="/assets/authors/inlife.jpg" class="w-12 h-12 rounded-full mr-4" alt="Vladyslav Hrytsenko"/><div class="text-xl font-bold">Vladyslav Hrytsenko</div></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div class="flex items-center"><img src="/assets/authors/inlife.jpg" class="w-12 h-12 rounded-full mr-4" alt="Vladyslav Hrytsenko"/><div class="text-xl font-bold">Vladyslav Hrytsenko</div></div></div><div class="mb-6 text-lg"><time class="text-gray-500" dateTime="2017-10-11T00:00:00.000Z">October	11, 2017</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__1x9gM"><p>Welcome everybody to our second post!</p>
<p>First of all we would like to give you guys updates about our current status, and what we have been doing for the past month. And oh boy, that was one hell of a month!</p>
<p>Lest start with nice list of things that we planned to do:</p>
<ul>
<li>Multi-threaded world reconstruction.</li>
<li>Re-visit and revamp all memory allocation strategies.</li>
<li>Add support of entity cooling, decreasing the number of updates sent.</li>
<li>Add ability to reject all possible built-in events.</li>
<li>Add fields: peer and "custom" pointer to the event structure, possibly giving them more potential.</li>
<li>Consider single-var context representation and context switching.</li>
<li>Add more assertions to possible user inputs.</li>
<li>And of course various performance optimizations.</li>
</ul>
<p>So, concluding the list above, we had 2 major tasks, refactor the library, to support contexts, or in other words, make it thread-safe. And second one, refactor the component system. The component system refactor was not actually mentioned above, but it was needed due to context implementation, and the way how components worked before.</p>
<pre><code class="language-c">#define LIBRG_IMPLEMENTATION
#define LIBRG_DEBUG
#include &#x3C;librg.h>

typedef struct { u32 bar; } foo;

void custom_components(librg_ctx_t *ctx) {
    librg_component_register(ctx, librg_component_last, sizeof(foo));
}

void on_connect_accepted(librg_event_t *event) {
    librg_log("someone connected to the server!\n");
}

int main() {
    // initialization
    librg_ctx_t ctx = {0};

    ctx.tick_delay   = 32;
    ctx.mode         = LIBRG_MODE_SERVER;
    ctx.world_size   = zplm_vec3(5000.0f, 5000.0f, 0.0f);

    librg_init(&#x26;ctx, custom_components);

    // adding event handlers
    librg_event_add(&#x26;ctx, LIBRG_CONNECTION_ACCEPT, on_connect_accepted);

    // starting server
    librg_address_t address = {0}; address.port = 27010;
    librg_network_start(&#x26;ctx, address);

    // starting main loop (run 100 times for test)
    for (int i = 0; i &#x3C; 100; ++i) {
        librg_tick(&#x26;ctx);
        zpl_sleep_ms(1);
    }

    // stopping network and freeing resources
    librg_network_stop(&#x26;ctx);
    librg_free(&#x26;ctx);

    return 0;
}
</code></pre>
<p>New component system has a few benefits, comparing it to old one, such as: the core implementation is macro-less now (previous one required you to use macro constructions to generate needed methods for the needed component), it is slightly faster, and the most important thing is, it is possible to bind component methods to the different scripting languages/implementations now. We also got rid of so-called, lazy-initialization for component pools, which makes your memory consumption increase somewhat unexpected for occasions when your are not really familiar with what is going on under the hood.</p>
<p>Next thing - context implementation.
The idea is simple, and you saw it in the most of proper-made C libraries out-there: provide context to each method. So this is basically exactly what we did. Updating method-API part, changing data structures, and re-organizing code inside implementation part, to make everything work simply, and nicely.</p>
<blockquote>
<p>Why do you need contexts, you can ask, they are just making the interface more complicated!</p>
</blockquote>
<p>Well it's a good question, first of all, with our previous approach you wouldn't be able to run multiple instances of librg inside one thread, and making let's say a server-client app/game bundled inside one application and inside one thread would be impossible.</p>
<p>As soon as we finished those 2 things mentioned above, we wanted to check, how hard it would be to create a bindings for the library, so we made librg-odin. And then we stared doing performance optimizations, decreasing amount of time needed for creation of update packet for each client.</p>
<p><img src="https://dl.dropboxusercontent.com/s/rgd0vuqyfop81kf/sublime_text_2017-10-03_16-52-17.png" alt=""></p>
<p>We started from around point of 300 ms per update for 1k connected clients + 10k entities, and successfully decreased the update time to only 10-20 ms per update for same conditions by making optimizations for cycles, minimizing repeated memory allocations, etc. And, the most important, adding support for multi-threaded update and entity culling insertion, which made the most significant difference.</p>
<p>We are currently also experimenting with world graph modification, to avoid re-constructing our k-d tree each time server updates our entities. This feature is currently volatile and requires further polishing, it may or may not be available in the 3.0 release.</p>
<p>All these changes lead to our new version 3.0.
Currently, we are still busy finishing some things, but we hope that we will be able to switch to 3.0 and mark it as stable within this month.</p>
<p>You can check out <strong>librg</strong> by following <a href="https://github.com/zpl-c/librg">this link</a>.</p>
<p>Thank you for reading!</p>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5 max-w-screen-lg"><div class="py-28 flex flex-col lg:flex-row items-center"><h3 class="text-4xl lg:text-5xl font-bold tracking-tighter leading-tight text-center lg:text-left mb-10 lg:mb-0 lg:pr-4 lg:w-1/2">A collection of single-file header-only libararies for C and C++.</h3><div class="flex flex-col lg:flex-row justify-center items-center lg:pl-4 lg:w-1/2"><a href="https://zpl.pw/fetch" class="mx-3 bg-black hover:bg-white hover:text-black border border-black text-white font-bold py-3 px-12 lg:px-8 duration-200 transition-colors mb-6 lg:mb-0">Download latest release</a><a href="https://github.com/zpl-c" class="mx-3 font-bold hover:underline">View on GitHub</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"librg - one month update!","date":"2017-10-11T00:00:00.000Z","slug":"librg-one-month-update","author":"inlife","content":"\u003cp\u003eWelcome everybody to our second post!\u003c/p\u003e\n\u003cp\u003eFirst of all we would like to give you guys updates about our current status, and what we have been doing for the past month. And oh boy, that was one hell of a month!\u003c/p\u003e\n\u003cp\u003eLest start with nice list of things that we planned to do:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMulti-threaded world reconstruction.\u003c/li\u003e\n\u003cli\u003eRe-visit and revamp all memory allocation strategies.\u003c/li\u003e\n\u003cli\u003eAdd support of entity cooling, decreasing the number of updates sent.\u003c/li\u003e\n\u003cli\u003eAdd ability to reject all possible built-in events.\u003c/li\u003e\n\u003cli\u003eAdd fields: peer and \"custom\" pointer to the event structure, possibly giving them more potential.\u003c/li\u003e\n\u003cli\u003eConsider single-var context representation and context switching.\u003c/li\u003e\n\u003cli\u003eAdd more assertions to possible user inputs.\u003c/li\u003e\n\u003cli\u003eAnd of course various performance optimizations.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSo, concluding the list above, we had 2 major tasks, refactor the library, to support contexts, or in other words, make it thread-safe. And second one, refactor the component system. The component system refactor was not actually mentioned above, but it was needed due to context implementation, and the way how components worked before.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e#define LIBRG_IMPLEMENTATION\n#define LIBRG_DEBUG\n#include \u0026#x3C;librg.h\u003e\n\ntypedef struct { u32 bar; } foo;\n\nvoid custom_components(librg_ctx_t *ctx) {\n    librg_component_register(ctx, librg_component_last, sizeof(foo));\n}\n\nvoid on_connect_accepted(librg_event_t *event) {\n    librg_log(\"someone connected to the server!\\n\");\n}\n\nint main() {\n    // initialization\n    librg_ctx_t ctx = {0};\n\n    ctx.tick_delay   = 32;\n    ctx.mode         = LIBRG_MODE_SERVER;\n    ctx.world_size   = zplm_vec3(5000.0f, 5000.0f, 0.0f);\n\n    librg_init(\u0026#x26;ctx, custom_components);\n\n    // adding event handlers\n    librg_event_add(\u0026#x26;ctx, LIBRG_CONNECTION_ACCEPT, on_connect_accepted);\n\n    // starting server\n    librg_address_t address = {0}; address.port = 27010;\n    librg_network_start(\u0026#x26;ctx, address);\n\n    // starting main loop (run 100 times for test)\n    for (int i = 0; i \u0026#x3C; 100; ++i) {\n        librg_tick(\u0026#x26;ctx);\n        zpl_sleep_ms(1);\n    }\n\n    // stopping network and freeing resources\n    librg_network_stop(\u0026#x26;ctx);\n    librg_free(\u0026#x26;ctx);\n\n    return 0;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNew component system has a few benefits, comparing it to old one, such as: the core implementation is macro-less now (previous one required you to use macro constructions to generate needed methods for the needed component), it is slightly faster, and the most important thing is, it is possible to bind component methods to the different scripting languages/implementations now. We also got rid of so-called, lazy-initialization for component pools, which makes your memory consumption increase somewhat unexpected for occasions when your are not really familiar with what is going on under the hood.\u003c/p\u003e\n\u003cp\u003eNext thing - context implementation.\nThe idea is simple, and you saw it in the most of proper-made C libraries out-there: provide context to each method. So this is basically exactly what we did. Updating method-API part, changing data structures, and re-organizing code inside implementation part, to make everything work simply, and nicely.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWhy do you need contexts, you can ask, they are just making the interface more complicated!\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWell it's a good question, first of all, with our previous approach you wouldn't be able to run multiple instances of librg inside one thread, and making let's say a server-client app/game bundled inside one application and inside one thread would be impossible.\u003c/p\u003e\n\u003cp\u003eAs soon as we finished those 2 things mentioned above, we wanted to check, how hard it would be to create a bindings for the library, so we made librg-odin. And then we stared doing performance optimizations, decreasing amount of time needed for creation of update packet for each client.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://dl.dropboxusercontent.com/s/rgd0vuqyfop81kf/sublime_text_2017-10-03_16-52-17.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eWe started from around point of 300 ms per update for 1k connected clients + 10k entities, and successfully decreased the update time to only 10-20 ms per update for same conditions by making optimizations for cycles, minimizing repeated memory allocations, etc. And, the most important, adding support for multi-threaded update and entity culling insertion, which made the most significant difference.\u003c/p\u003e\n\u003cp\u003eWe are currently also experimenting with world graph modification, to avoid re-constructing our k-d tree each time server updates our entities. This feature is currently volatile and requires further polishing, it may or may not be available in the 3.0 release.\u003c/p\u003e\n\u003cp\u003eAll these changes lead to our new version 3.0.\nCurrently, we are still busy finishing some things, but we hope that we will be able to switch to 3.0 and mark it as stable within this month.\u003c/p\u003e\n\u003cp\u003eYou can check out \u003cstrong\u003elibrg\u003c/strong\u003e by following \u003ca href=\"https://github.com/zpl-c/librg\"\u003ethis link\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThank you for reading!\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"librg-one-month-update"},"buildId":"2UYYWxh3WSItHyBckj0jJ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-28e8df78bab9fb79adb9.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.9d524150d48315f49e80.js" async=""></script><script src="/_next/static/chunks/commons.4595204cc52e81c182fd.js" async=""></script><script src="/_next/static/chunks/pages/_app-83685d3b0871724b112c.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.2d988ae86865e9e9ee4d.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-288ab15c4ca0236ea538.js" async=""></script><script src="/_next/static/2UYYWxh3WSItHyBckj0jJ/_buildManifest.js" async=""></script><script src="/_next/static/2UYYWxh3WSItHyBckj0jJ/_ssgManifest.js" async=""></script></body></html>